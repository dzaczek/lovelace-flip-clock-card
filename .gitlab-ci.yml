stages:
  - build
  - release

variables:
  PACKAGE_NAME: "flip-clock-card"
  VERSION: "25.0.1-beta"

build:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache zip
  script:
    - echo "Building package for HACS..."
    - mkdir -p dist/${PACKAGE_NAME}
    - cp flip-clock-card.js dist/${PACKAGE_NAME}/
    - cp hacs.json dist/${PACKAGE_NAME}/
    - cp README.md dist/${PACKAGE_NAME}/
    - cp LICENSE dist/${PACKAGE_NAME}/
    - cp -r img dist/${PACKAGE_NAME}/ 2>/dev/null || true
    - cd dist
    - zip -r ${PACKAGE_NAME}-${VERSION}.zip ${PACKAGE_NAME}/
    - tar -czf ${PACKAGE_NAME}-${VERSION}.tar.gz ${PACKAGE_NAME}/
    - cd ..
    - echo "Package built successfully"
  artifacts:
    paths:
      - dist/${PACKAGE_NAME}-${VERSION}.zip
      - dist/${PACKAGE_NAME}-${VERSION}.tar.gz
    expire_in: 30 days
  only:
    - tags
    - beta
    - main
    - master

release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        VERSION="${VERSION}"
      fi
      
      echo "Preparing release ${VERSION}..."
      echo "Package files are available in build artifacts"
      echo ""
      echo "To create a release in GitLab:"
      echo "1. Go to Repository > Releases"
      echo "2. Click 'New release'"
      echo "3. Select tag: ${VERSION}"
      echo "4. Add release notes"
      echo "5. Attach artifacts from build job"
      echo ""
      echo "Or use GitLab API with GITLAB_TOKEN variable:"
      echo "curl --request POST \\"
      echo "  --header \"PRIVATE-TOKEN: \${GITLAB_TOKEN}\" \\"
      echo "  --header \"Content-Type: application/json\" \\"
      echo "  --data '{\"name\": \"Release ${VERSION}\", \"tag_name\": \"${VERSION}\"}' \\"
      echo "  \"\${CI_API_V4_URL}/projects/\${CI_PROJECT_ID}/releases\""
  only:
    - tags
  when: manual
  allow_failure: true

